<?php

use Drupal\contact\ContactMessageInterface;
use Drupal\Core\Url;

/**
 * @file
 * Custom email formatting for the Contact Us form notifications.
 */

/**
 * Implements hook_mail_alter().
 */
function acp_contact_email_mail_alter(array &$message) {
  // We only care about the site-wide contact form emails:
  // - contact_page_mail  (notification to recipients)
  // - contact_page_copy  (copy to sender).
  if (empty($message['id']) || !in_array($message['id'], ['contact_page_mail', 'contact_page_copy'], TRUE)) {
    return;
  }

  // Ensure we have the contact_message entity and that it's the contact_us_form.
  if (
    empty($message['params']['contact_message']) ||
    !$message['params']['contact_message'] instanceof ContactMessageInterface
  ) {
    return;
  }

  /** @var \Drupal\contact\ContactMessageInterface $contact_message */
  $contact_message = $message['params']['contact_message'];
  if ($contact_message->bundle() !== 'contact_us_form') {
    // Do not touch other contact forms (e.g., partner form).
    return;
  }

  $langcode = $message['langcode'] ?? $contact_message->language()->getId();
  $is_ar = ($langcode === 'ar');

  // Extract submitted fields.
  $name = $contact_message->get('field_name')->value ?? '';
  $email = $contact_message->get('field_email')->value ?? '';
  $phone = $contact_message->get('field_phone_number')->value ?? '';
  $body = $contact_message->get('field_message')->value ?? '';

  // Build a clean, labeled link to the form page.
  $language = \Drupal::languageManager()->getLanguage($langcode);
  $form_url = Url::fromRoute('<current>', [], [
    'absolute' => TRUE,
    'language' => $language,
  ])->toString();

  $form_link_label = $is_ar
    ? t('Open the contact form on the website', [], ['langcode' => 'ar'])
    : t('Open the contact form on the website', [], ['langcode' => $langcode]);

  // Determine direction and alignment for mixed LTR/RTL content.
  $direction = $is_ar ? 'rtl' : 'ltr';
  $align = $is_ar ? 'right' : 'left';

  // Build the intro line without exposing the raw URL.
  $sender = $message['params']['sender'] ?? NULL;
  $sender_name = '';
  if ($sender && method_exists($sender, 'getDisplayName')) {
    $sender_name = $sender->getDisplayName();
  }

  if ($is_ar) {
    $intro = t(
      '@sender-name أرسل رسالة عبر نموذج "تواصل معنا" على الموقع.',
      ['@sender-name' => $sender_name],
      ['langcode' => 'ar']
    );
  }
  else {
    $intro = t(
      '@sender-name sent a message using the "Contact Us" form on the website.',
      ['@sender-name' => $sender_name],
      ['langcode' => $langcode]
    );
  }

  // Safely escape field values for HTML context.
  $escape = static function ($value) {
    return htmlspecialchars((string) $value, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
  };

  // Build table rows only for fields that have values.
  $rows = [];
  if ($name !== '') {
    $rows[] = sprintf(
      '<tr><th align="%s">%s</th><td>%s</td></tr>',
      $align,
      $escape($is_ar ? 'الاسم' : 'Name'),
      $escape($name)
    );
  }
  if ($email !== '') {
    $rows[] = sprintf(
      '<tr><th align="%s">%s</th><td><a href="mailto:%s">%s</a></td></tr>',
      $align,
      $escape($is_ar ? 'البريد الإلكتروني' : 'Email'),
      $escape($email),
      $escape($email)
    );
  }
  if ($phone !== '') {
    $rows[] = sprintf(
      '<tr><th align="%s">%s</th><td>%s</td></tr>',
      $align,
      $escape($is_ar ? 'رقم الهاتف' : 'Phone'),
      $escape($phone)
    );
  }
  if ($body !== '') {
    $rows[] = sprintf(
      '<tr><th valign="top" align="%s">%s</th><td>%s</td></tr>',
      $align,
      $escape($is_ar ? 'الرسالة' : 'Message'),
      nl2br($escape($body))
    );
  }

  $table_html = sprintf(
    '<table dir="%s" style="border-collapse:collapse;width:100%%;margin-top:12px;">%s</table>',
    $direction,
    implode('', $rows)
  );

  $link_html = sprintf(
    '<p dir="%s" style="margin-top:16px;">' .
    '<a href="%s" ' .
    'style="display:inline-block;padding:10px 18px;background-color:#32D2A0;color:#ffffff;' .
    'text-decoration:none;border-radius:4px;font-weight:600;">%s</a></p>',
    $direction,
    $escape($form_url),
    $escape($form_link_label)
  );

  // Set the body to our clean, HTML-formatted content.
  $message['body'] = [
    sprintf('<p dir="%s" style="margin:0 0 8px 0;">%s</p>', $direction, $escape($intro)),
    $table_html,
    $link_html,
  ];

  // Ensure the email is sent as HTML so our layout and link styling render.
  $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
}


